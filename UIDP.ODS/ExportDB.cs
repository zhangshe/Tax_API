using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Text;
using UIDP.UTILITY;

namespace UIDP.ODS
{
    public class ExportDB
    {
        DBTool db = new DBTool("MYSQL");
        /// <summary>
        /// 获取当月金税部门纳税人员列表
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        public DataTable getExportPayerInfo(Dictionary<string,object> d)
        {
            string sql = "SELECT a.*,d.Name AS edu,e.Name AS occ,f.Name AS wor,g.Name AS idt,h.Name AS nat,i.Name AS jobt,j.Name AS otheridt FROM tax_taxpayerinfo a ";
            sql += " JOIN tax_org b ON a.S_OrgCode= b.S_OrgCode  and b.TaxCode='"+ d["TaxNumber"].ToString() + "' ";
            sql += " JOIN tax_salary c ON a.WorkerNumber= c.S_WorkerCode ";
            sql += " LEFT JOIN tax_dictionary d ON a.Education=d.Code";
            sql += " LEFT JOIN tax_dictionary e ON a.Occupation=e.Code";
            sql += " LEFT JOIN tax_dictionary f ON a.WorkPost=f.Code";
            sql += " LEFT JOIN tax_dictionary g ON a.IdType=g.Code";
            sql += " LEFT JOIN tax_dictionary h ON a.Nationality=h.Code";
            sql += " LEFT JOIN tax_dictionary i ON a.JobType=i.Code";
            sql += " LEFT JOIN tax_dictionary j ON a.OtherIdType=j.Code";
            sql += " WHERE a.S_OrgCode LIKE '"+d["OrgCode"].ToString()+"%'";
            sql += " AND DATEDIFF(m,c.S_WorkDate,'" + d["WorkDate"].ToString() + "')=0";
            //sql += " AND a.S_OrgCode='100006013'";
            //sql += " WHERE a.WorkerNumber in ('55852815','551478','542829','568225','1427121','142756','595220','568384','568377','568375','568372','568367','568363','568362','568359','568355','568354','568350','568346','568342','568339','568333','568330','568329','568326','568324','568321','568320','568319','568316','568312','568310','568306','568303','568302','568300','568298','568296','568293','568292','568291','568290','568288','568283','568277','568273','568272','568271','568270','568267','568258','568257','568256','568255','568254','568250','568248','568246','568245','568242','568240','568238','568232','568229','568228','568224','568221','568219','568217','568213','568212','568202','568201','568200','568199','568197','568196','568195','568194','568190','568189','568188','568187','568181','568180','568177','568169','568166','568161','568156','568155','568151','568146','568145','568143','568137','568135','568134','568133','568132','568129','568128','568126','568125','568124','568123','568122','568120','568116','568113','568108','568107','568104','568102','568098','568096','568094','568093','568091','568087','568086','568083','568080','568075','568074','568069','568064','568062','568060','568058','568052','568051','568047','568044','568043','568041','568039','568038','568037','568036','568034','568032','568019','568014','568012','568010','568009','568007','568005','562570','562564','562537','562533','562354','562244','562210','562202','562193','562124','562118','562117','562116','562115','562114','562113','562112','562111','562110','562105','562104','562103','562101','562098','562097','562091','562090','562089','562086','562082','562075','561926','561864','561859','561848','561790','561785','561777','561754','561581','561570','561531','561462','561460','561379','561370','561354','561325','561307','561306','561304','561303','561302','561297','561295','561268','561252','561219','561218','561217','561216','561215','561213','561212','561211','561210','561209','561208','561207','561205','561204','561201','561198','561197','561187','561164','561158','561135','561108','561104','561100','561028','561027','561026','561025','561021','561016','561009','561003','560978','560898','560896','560886','560879','560772','560748','560522','560385','560355','560225','560221','560129','560127','560126','560125','560124','560123','560122','560120','560119','560118','560117','560116','560115','560112','560110','560109','560108','560106','560105','560104','560103','560102','560101','560100','560098','560095','560094','560091','560090','560089','560088','560085','560083','560081','560080','560077','560076','560074','560072','560071','560070','560068','560066','560065','560062','560061','560057','560056','560054','560053','560052','560051','560050','560049','560048','560047','560045','560043','560042','560041','560040','560039','560037','560036','560034','560033','560032','560031','560030','560029','560028','560027','560026','560023','560022','560020','560019','560018','560017','560016','560015','560013','560012','560010','560009','560008','560007','560004','560002','560001','559999','559998','559997','559996','559995','559994','559993','559992','559991','559990','559989','559987','559986','559985','559984','559983','559982','559981','559980','559977','559976','559975','559972','559971','559970','559969','559968','559967','559966','559964','559963','559961','559960','559959','559958','559956','559953','559952','559951','559950','559949','559944','559942','559941','559938','559937','559936','559935','559932','559931','559930','559926','559925','559924','559922','559921','559919','559918','559917','559915','559914','559913','559911','559909','559907','559906','559904','559903','559901','559900','559899','559897','559896','559895','559894','559892','559891','559890','559887','559886','559885','559883','559882','559881','559879','559878','559875','559874','559873','559872','559870','559866','559863','559861','559860','559859','559858','559857','559855','559854','559853','559852','559850','559849','559848','559847','559846','559845','559843','559842','559841','559839','559837','559836','559835','559834','559833','559832','559831','559830','559829','559828','559826','559824','559821','559820','559818','559815','559814','559813','559812','559811','559810','559809','559804','559803','559802','559801','559800','559799','559798','559795','559794','559792','559789','559788','559787','559785','559783','559782','559781','559778','559777','559776','559773','559770','559768','559766','559765','559764','559763','559762','559761','559760','559757','559756','559755','559754','559753','559752','559751','559750','559749','559748','559747','559746','559744','559742','559741','559740','559737','559736','559735','559734','559733','559731','559730','559729','559728','559727','559725','559724','559723','559722','559720','559719','559718','559717','559716','559714','559711','559710','559709','559707','559706','559703','559702','559699','559698','559697','559696','559695','559694','559691','559690','559689','559687','559686','559685','559684','559683','559682','559681','559679','559677','559676','559674','559673','559672','559671','559670','559669','559668','559665','559661','559660','559658','559657','559655','559654','559653','559651','559649','559646','559644','559642','559640','559638','559637','559636','559635','559633','559632','559629','559628','559627','559626','559625','559624','559623','559621','559620','559619','559618','559616','559615','559614','559612','559608','559606','559605','559603','559602','559600','559599','559597','559596','559595','559593','559591','559589','559588','559586','559585','559584','559583','559582','559580','559579','559577','559576','559575','559574','559573','559572','559571','559570','559569','559567','559566','559565','559564','559563','559561','559560','559559','559556','559555','559554','559553','559550','559549','559548','559547','559545','559543','559541','559540','559538','559537','559534','559533','559532','559526','559525','559524','559521','559520','559518','559517','559516','559513','559512','559508','559505','559504','559502','559500','559499','559498','559497','559496','559495','559494','559493','559492','559491','559489','559487','559486','559485','559480','559478','559477','559474','559473','559471','559470','559467','559466','559465','559461','559456','559455','559454','559452','559450','559449','559448','559447','559446','559444','559443','559442','559441','559439','559438','559436','559435','559434','559432','559428','559426','559424','559423','559422','559421','559420','559419','559418','559417','559415','559414','559413','559412','559411','559410','559409','559408','559406','559405','559404','559401','559398','559397','559396','559395','559392','559390','559387','559385','559384','559383','559382','559380','559378','559377','559376','559374','559373','559372','559371','559370','559367','559365','559363','559360','559359','559358','559357','559356','559355','559354','559353','559352','559351','559349','559347','559346','559345','559343','559339','559338','559334','559333','559332','559331','559329','559328','559327','559325','559324','559323','559320','559319','559316','559315','559311','559308','559307','559306','559303','559302','559301','559300','559299','559297','559295','559294','559293','559292','559291','559290','559289','559288','559287','559284','559282','559281','559280','559279','559278','559277','559276','559275','559271','559270','559269','559268','559267','559265','559264','559263','559262','559261','559260','559259','559258','559257','559256','559255','559253','559252','559251','559250','559249','559248','559247','559246','559245','559244','559243','559241','559240','559239','559237','559235','559234','559233','559232','559231','559230','559229','559228','559227','559224','559223','559222','559221','559217','559214','559213','559212','559210','559209','559207','559205','559203','559202','559201','559200','559199','559197','559196','559192','559191','559188','559187','559186','559185','559184','559183','559182','559181','559180','559177','559175','559174','559173','559172','559170','559168','559166','559165','559164','559162','559161','559159','559158','559157','559156','559155','559154','559152','559151','559150','559148','559147','559145','559142','559141','559140','559139','559137','559134','559133','559132','559131','559130','559127','559126','559124','559123','559122','559121','559120','559119','559117','559115','559114','559113','559109','559108','559106','559105','559104','559102','559101','559100','559099','559098','559097','559094','559090','559089','559087','559086','559085','559080','559079','559078','559076','559075','559074','559073','559072','559071','559068','559067','559066','559065','559064','559062','559061','559060','559059','559058','559057','559055','559051','559049','559048','559046','559043','559042','559041','559040','559039','559036','559031','559030','559029','559028','559027','559026','559024','559023','559022','559020','559018','559017','559016','559015','559014','559013','559009','559008','559005','559003','559002','559001','558999','558998','558997','558996','558995','558994','558992','558991','558990','558988','558985','558984','558983','558981','558980','558979','558978','558975','558974','558972','558969','558964','558962','558961','558960','558958','558957','558956','558955','558954','558951','558950','558949','558946','558945','558944','558943','558941','558938','558936','558935','558934','558933','558932','558931','558928','558927','558926','558924','558923','558922','558921','558919','558918','558917','558901','558887','558839','558838','558837','558836','558824','558660','558656','558533','558522','558520','558453','558449','558426','558358','558357','558280','558268','558166','558159','558153','558152','558151','558150','558148','558147','558146','558145','558143','558142','558141','558139','558138','558137','558136','558135','558134','558133','558132','558131','558130','558129','558128','558127','558106','558082','558081','558080','558079','558020','558017','557869','557522','557336','557269','557268','557256','557224','557186','557161','557160','557146','557138','557106','557100','557095','557058','557041','556970','556423','555928','555901','555571','555170','555017','554969','554966','554894','554641','554634','554629','554623','554586','554581','554565','554516','554500','554236','554104','553885','553774','553698','553540','553105','553067','553066','553064','553063','553060','553057','553054','553051','553047','553046','553045','553038','553035','553032','553028','553025','553003','552995','552976','552967','552960','552891','552832','552831','552829','552828','552824','552823','552818','552817','552813','552806','552805','552801','552800','552799','552798','552796','552795','552792','552785','552783','552781','552780','552779','552778','552775','552774','552773','552771','552770','552769','552768','552767','552766','552765','552764','552760','552759','552756','552751','552748','552744','552733','552728','552726','552725','552724','552723','552718','552716','552714','552713','552711','552710','552709','552708','552704','552703','552699','552698','552332','552158','552067','552032','552013','552012','552009','552003','552001','551985','551982','551976','551974','551972','551970','551958','551957','551951','551945','551919','551913','551904','551894','551891','551885','551867','551856','551855','551852','551851','551850','551849','551848','551847','551846','551844','551825','551822','551796','551793','551792','551785','551770','551754','551746','551737','551727','551721','551720','551715','551705','551702','551691','551663','551649','551645','551642','551603','551595','551588','551579','551572','551541','551518','551454','551426','551414','551373','551365','551363','551354','551353','551351','551349','551344','551342','551340','551335','551334','551333','551332','551331','551329','551327','551325','551321','551319','551311','551301','551295','551292','551288','551287','551283','551277','551272','551270','551268','551263','551260','551257','551256','551253','551244','551239','551233','551232','551228','551221','551220','551219','551217','551214','551210','551209','551208','551206','551202','551201','551200','551199','551197','551196','551194','551192','551190','551189','551184','551180','551172','551166','551160','551156','551152','551151','551148','551139','551135','551129','551126','551109','551107','551106','551105','551104','551103','551090','551087','551081','551080','551077','551071','551070','551060','551058','551055','551052','551050','551049','551043','551042','551035','551028','551026','551022','551020','551017','551016','551007','551004','551001','550998','550997','550992','550990','550989','550987','550984','550981','550977','550974','550971','550969','550966','550964','550960','550959','550958','550949','550942','550934','550933','550928','550926','550921','550920','550917','550914','550913','550908','550905','550903','550902','550898','550896','550894','550893','550889','550888','550887','550884','550879','550878','550877','550876','550875','550873','550868','550867','550861','550856','550852','550850','550847','550845','550844','550841','550839','550835','550834','550832','550828','550825','550824','550813','550811','550804','550802','550795','550794','550793','550786','550782','550778','550777','550775','550774','550772','550770','550768','550767','550766','550765','550764','550760','550759','550758','550753','550747','550745','550739','550738','550731','550729','550726','550723','550716','550714','550712','550711','550705','550702','550701','550699','550694','550687','550686','550682','550680','550677','550675','550674','550673','550671','550668','550663','550662','550659','550658','550657','550655','550654','550653','550648','550646','550645','550642','550641','550640','550639','550638','550636','550635','550632','550620','550609','550591','550560','550431','550409','550056','550044','550032','550028','550026','550024','550023','550022','550018','550013','550008','550005','550003','549527','527960','511691','558947')";
            return db.GetDataTable(sql);
        }
        /// <summary>
        /// 获取纳税人变动信息（导出用）
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        public DataTable getChangePayerInfo(Dictionary<string,object> d)
        {
            string sql = " SELECT DISTINCT a.*,d.Name AS edu,e.Name AS occ,f.Name AS wor,g.Name AS idt,h.Name AS nat,i.Name AS jobt,j.Name AS otheridt FROM tax_taxpayerinfo a ";
            sql += " JOIN tax_org b ON a.S_OrgCode= b.S_OrgCode  and b.TaxCode='" + d["TaxNumber"].ToString() + "' ";
            sql += " LEFT JOIN tax_dictionary d ON a.Education=d.Code";
            sql += " LEFT JOIN tax_dictionary e ON a.Occupation=e.Code";
            sql += " LEFT JOIN tax_dictionary f ON a.WorkPost=f.Code";
            sql += " LEFT JOIN tax_dictionary g ON a.IdType=g.Code";
            sql += " LEFT JOIN tax_dictionary h ON a.Nationality=h.Code";
            sql += " LEFT JOIN tax_dictionary i ON a.JobType=i.Code";
            sql += " LEFT JOIN tax_dictionary j ON a.OtherIdType=j.Code";
            sql += " WHERE a.S_OrgCode LIKE'" + d["OrgCode"] + "%'";
            sql += " AND (DATEDIFF(mm,a.EmployeeDate,'" + d["WorkDate"] + "')=0";
            sql += " OR DATEDIFF(mm,a.QuitDate,'" + d["WorkDate"] + "')=0";
            sql += " OR DATEDIFF(mm,a.QuitDate,'" + d["WorkDate"] + "')=1";
            sql += " OR DATEDIFF(mm,a.S_UpdateDate,'" + d["WorkDate"] + "')=0)";
            return db.GetDataTable(sql);
        }
        /// <summary>
        /// 查询当月金税部门工资详情
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        public DataTable getExportSalary(Dictionary<string,object> d)
        {
            IDataParameter[] parm = new SqlParameter[3];
            parm[0] = new SqlParameter("@OrgCode", SqlDbType.NVarChar, 50);
            parm[1] = new SqlParameter("@WorkDate", SqlDbType.DateTime);
            parm[2] = new SqlParameter("@TaxNumber", SqlDbType.NVarChar, 50);
            parm[0].Value = d["OrgCode"];
            parm[1].Value = d["WorkDate"];
            parm[2].Value = d["TaxNumber"];
            DataSet ds = db.GetProcedure("pro_JinShuiDaoChu", parm);
            if (ds != null && ds.Tables.Count > 0)
                return ds.Tables[0];
            else
                return new DataTable();
        }
        /// <summary>
        /// 查询当月金税部门一次性奖金详情
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        public DataTable getExportOnceBonus(Dictionary<string,object> d)
        {
            string sql = "SELECT a.* FROM tax_onetimebonus a ";
            // sql += "LEFT JOIN tax_org b ON a.S_OrgCode=b.S_OrgCode";
            sql += " LEFT JOIN tax_org b ON a.S_OrgCode= b.S_OrgCode  and b.TaxCode='" + d["TaxNumber"].ToString() + "' ";
            sql += " WHERE a.S_OrgCode LIKE '"+d["OrgCode"].ToString()+"%'";
             sql+= " AND DATEDIFF(m, a.S_WorkDate,'"+d["WorkDate"].ToString()+"')=0";
            // sql+= " AND b.OrgTaxOffice='HB'";
             sql+= " ORDER BY S_OrgCode";
            return db.GetDataTable(sql);
        }
        /// <summary>
        /// 查询本级和下级单位状态（不包括根节点）
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        public DataTable getOrgStatus(Dictionary<string, object> d)
        {
            string sql = " select * from (select isnull(c.S_Id,'') S_Id,isnull(c.S_WorkDate,'')S_WorkDate,a.ORG_ID,a.ORG_NAME S_OrgName,a.ORG_CODE S_OrgCode,isnull(b.IsComputeTax,0) IsComputeTax,CASE WHEN((b.IsComputeTax = 0 OR b.IsComputeTax IS NULL) and c.ReportStatus is null ) THEN '1' ELSE isnull(c.ReportStatus,-1) END ReportStatus  ";
            sql += "  from ts_uidp_org a ";
            sql += "  join tax_org  b on a.ORG_CODE=b.S_OrgCode ";
            sql += "  left join tax_reportstatus c on c.S_OrgCode=a.ORG_CODE and DATEDIFF(m,c.S_WorkDate,'" + DateTime.Parse(d["WorkDate"].ToString()).ToString("yyyy-MM-dd") + "')=0 ";
            sql += " where a.ORG_CODE='" + d["OrgCode"].ToString() + "' and len(a.ORG_CODE)>3 ";
            // sql += " and  exists (select  1  from tax_taxpayerinfo where S_OrgCode=a.ORG_CODE ) ";
            if (d["TaxNumber"] != null && d["TaxNumber"].ToString() != "")
            {
                sql += "AND b.TaxCode='" + d["TaxNumber"] + "' ";
            }
            sql += " ) d ";
            if (d["Status"] != null)
            {
                sql += "where d.ReportStatus=" + d["Status"];
            }
           
            sql += " union  ";
            sql += " select * from ( select  isnull(c.S_Id,'') S_Id,isnull(c.S_WorkDate,'')S_WorkDate,a.ORG_ID,a.ORG_NAME S_OrgName,a.ORG_CODE S_OrgCode,isnull(b.IsComputeTax,0) IsComputeTax,CASE WHEN((b.IsComputeTax = 0 OR b.IsComputeTax IS NULL) and c.ReportStatus is null ) THEN '1' ELSE isnull(c.ReportStatus,-1) END ReportStatus    ";
            sql += " from ts_uidp_org a ";
            sql += "  join tax_org  b on a.ORG_CODE=b.S_OrgCode  ";
            sql += " left join tax_reportstatus c on c.S_OrgCode=a.ORG_CODE and DATEDIFF(m,c.S_WorkDate,'" + DateTime.Parse(d["WorkDate"].ToString()).ToString("yyyy-MM-dd") + "')=0 ";
            sql += " where a.ORG_CODE like '" + d["OrgCode"].ToString() + "'+'%' AND a.ORG_CODE<>'" + d["OrgCode"].ToString() + "' and LEN(a.ORG_CODE)=LEN('" + d["OrgCode"].ToString() + "')+3 ";
            // sql += " and  exists (select  1  from tax_taxpayerinfo where S_OrgCode=a.ORG_CODE ) ";
            // sql += " and not exists (select 1 from tax_org  d where a.ORG_CODE=d.S_OrgCode and d.IsComputeTax=1) ";//以上是查部门
            if (d["TaxNumber"] != null && d["TaxNumber"].ToString() != "")
            {
                sql += "AND b.TaxCode='" + d["TaxNumber"] + "' ";
            }
            sql += " ) d ";
            if (d["Status"] != null)
            {
                sql += "AND d.ReportStatus=" + d["Status"];
            }
            
            return db.GetDataTable(sql);
        }
        /// <summary>
        /// 查询当前登录人的单位以及下级的税号
        /// </summary>
        /// <param name="d"></param>
        /// <returns></returns>
        public DataTable getTaxNumberOptions(Dictionary<string,object> d)
        {
            string sql = "SELECT distinct b.Name,b.Code,b.EnglishCode FROM tax_org a";
            sql += " LEFT JOIN tax_dictionary b ON a.TaxCode=b.Code";
            sql += " WHERE S_OrgCode LIKE'" + d["OrgCode"] + "%'";
            return db.GetDataTable(sql);
        }
    }
}
